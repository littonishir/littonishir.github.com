<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Android View绘制流程解析 | litton ishir</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="https://upload-images.jianshu.io/upload_images/1074123-dc819e68a5f3c3f7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
    <meta name="description" content=""Someday"sounds a lot like the thing people say when they actually mean "Never". ">
    
    <link rel="preload" href="/assets/css/1.styles.58afc4b7.css" as="style"><link rel="preload" href="/assets/js/app.5b687ac1.js" as="script"><link rel="preload" href="/assets/js/3.9a559813.js" as="script"><link rel="preload" href="/assets/js/21.672831ec.js" as="script"><link rel="prefetch" href="/assets/js/0.58b532e0.js"><link rel="prefetch" href="/assets/js/10.af93e76f.js"><link rel="prefetch" href="/assets/js/11.e5b83fb5.js"><link rel="prefetch" href="/assets/js/12.962c1c34.js"><link rel="prefetch" href="/assets/js/13.04f4a43e.js"><link rel="prefetch" href="/assets/js/14.7e5d7144.js"><link rel="prefetch" href="/assets/js/15.9e1637dc.js"><link rel="prefetch" href="/assets/js/16.ea8c34b4.js"><link rel="prefetch" href="/assets/js/17.aef368c2.js"><link rel="prefetch" href="/assets/js/18.0fdc9c21.js"><link rel="prefetch" href="/assets/js/19.647e9c7b.js"><link rel="prefetch" href="/assets/js/20.5b2b833a.js"><link rel="prefetch" href="/assets/js/22.6ce0c8f7.js"><link rel="prefetch" href="/assets/js/23.092f9a37.js"><link rel="prefetch" href="/assets/js/24.1e64fa47.js"><link rel="prefetch" href="/assets/js/25.954d07dd.js"><link rel="prefetch" href="/assets/js/26.01b668c2.js"><link rel="prefetch" href="/assets/js/27.5cbb307f.js"><link rel="prefetch" href="/assets/js/28.09d095cc.js"><link rel="prefetch" href="/assets/js/29.3027f83a.js"><link rel="prefetch" href="/assets/js/30.a982243b.js"><link rel="prefetch" href="/assets/js/31.fcd37d2c.js"><link rel="prefetch" href="/assets/js/32.d2dedbc4.js"><link rel="prefetch" href="/assets/js/33.bebc1ba6.js"><link rel="prefetch" href="/assets/js/34.ebabb575.js"><link rel="prefetch" href="/assets/js/35.d82e0491.js"><link rel="prefetch" href="/assets/js/36.8501289b.js"><link rel="prefetch" href="/assets/js/37.9f4c0a5d.js"><link rel="prefetch" href="/assets/js/38.90781ccb.js"><link rel="prefetch" href="/assets/js/39.38253aca.js"><link rel="prefetch" href="/assets/js/4.5d06848d.js"><link rel="prefetch" href="/assets/js/40.09187989.js"><link rel="prefetch" href="/assets/js/41.85df326a.js"><link rel="prefetch" href="/assets/js/42.a832e60d.js"><link rel="prefetch" href="/assets/js/43.1e3c87ef.js"><link rel="prefetch" href="/assets/js/44.7cea1c79.js"><link rel="prefetch" href="/assets/js/45.192216a9.js"><link rel="prefetch" href="/assets/js/46.f2c11f24.js"><link rel="prefetch" href="/assets/js/47.e3c0d57a.js"><link rel="prefetch" href="/assets/js/48.16fe64d3.js"><link rel="prefetch" href="/assets/js/5.6c57b99b.js"><link rel="prefetch" href="/assets/js/6.f694b0b5.js"><link rel="prefetch" href="/assets/js/7.c7a905cb.js"><link rel="prefetch" href="/assets/js/8.bc0ced29.js"><link rel="prefetch" href="/assets/js/9.a72dd2e1.js">
    <link rel="stylesheet" href="/assets/css/1.styles.58afc4b7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="container"><div id="head-c"><div class="row"><div class="offset-lg-2 col-lg-8 offset-md-1 col-md-10"><h1 id="blog-name"><a href="/" class="router-link-active">
                litton ishir
            </a></h1> <a href="https://weibo.com/littonishir" target="_blank" class="social"><i class="fa fa-fw fa-weibo"></i></a><a href="https://github.com/littonishir" target="_blank" class="social"><i class="fa fa-fw fa-github"></i></a><a href="https://space.bilibili.com/268398214/" target="_blank" class="social"><i class="fa fa-fw fa-terminal"></i></a><a href="https://www.instagram.com/littonishir/" target="_blank" class="social"><i class="fa fa-fw fa-instagram"></i></a></div></div></div> <div class="row"><div class="offset-lg-2 col-lg-8 offset-md-1 col-md-10"><div><article><p class="post-page-meta">Mar 19, 2019</p> <hr> <div class="content__default"><h1 id="android-view绘制流程解析"><a href="#android-view绘制流程解析" class="header-anchor">#</a> Android View绘制流程解析</h1> <p>我们首先来看张图，当 Activity 启动时，我们会通过 setContentView 方法来设置内容视图，这个内容视图就是用户看到的界面。</p> <p><img src="https://upload-images.jianshu.io/upload_images/1074123-de59fe72ca61cb3d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="20180325115530683.png"></p> <h2 id="_1-请简述activity-与-window、phonewindow、decorview-之间的关系"><a href="#_1-请简述activity-与-window、phonewindow、decorview-之间的关系" class="header-anchor">#</a> 1. 请简述Activity 与 Window、PhoneWindow、DecorView 之间的关系</h2> <p><strong>Window:</strong> 每一个 Activity 都持有一个 Window 对象，但是 Window 是一个抽象类，这里 Android 为 Window 提供了唯一的实现类 PhoneWindow。</p> <p><strong>PhoneWindow:</strong> 终究还是 Window，它并不具备多少 View 相关的能力。PhoneWindow 持有一个 Android 中非常重要的一个 View 对象 DecorView.</p> <p><strong>DectorView:</strong> 是FrameLayout的一个子类，是所有Activity的根View，它主要有以下功能</p> <ul><li>处理事件的分发；</li> <li>解析当前系统UI的风格 （从系统的Layout.xml中，如是否带title、是否带process bar等）。</li> <li>作为PhoneWindow与ViewRoot之间的桥梁，ViewRoot通过DecorView设置窗口属性。//可以这样获取 View view = getWindow().getDecorView();</li> <li>DecorView包含通知栏，标题栏，内容显示栏三块区域。
<ul><li>DecorView里面TitleView：标题，可以设置requestWindowFeature(Window.FEATURE_NO_TITLE)取消掉。</li> <li>ContentView：是一个id为content的ViewGroup。我们平常在Activity使用的setContentView就是设置在这里，也就是在ViewGroup上</li></ul></li></ul> <h5 id="总结"><a href="#总结" class="header-anchor">#</a> 总结：</h5> <p>每一个 Activity 持有一个 PhoneWindow 的对象，而一个 PhoneWindow 对象持有一个 DecorView 的实例，所有Activity 中 View 相关的操作其实大都是通过 DecorView 来完成。</p> <h2 id="_2-请简述view绘制的整体流程"><a href="#_2-请简述view绘制的整体流程" class="header-anchor">#</a> 2. 请简述View绘制的整体流程</h2> <p>当一个应用启动时，会启动一个主 Activity，Android 系统会根据 Activity 的布局来对它进行绘制。绘制会从根视图 ViewRoot 的 performTraversals() 方法开始，从上到下遍历整个视图树，每个 View 控制负责绘制自己，而 ViewGroup 还需要负责通知自己的子 View 进行绘制操作。视图操作的过程可以分为三个步骤，分别是测量(Measure)、布局(Layout)和绘制(Draw)。performTraversals 方法在 类 ViewRootImpl 内，其核心代码如下</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">int</span> childWidthMeasureSpec <span class="token operator">=</span> <span class="token function">getRootMeasureSpec</span><span class="token punctuation">(</span>mWidth<span class="token punctuation">,</span> lp<span class="token punctuation">.</span>width<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> childHeightMeasureSpec <span class="token operator">=</span> <span class="token function">getRootMeasureSpec</span><span class="token punctuation">(</span>mHeight<span class="token punctuation">,</span> lp<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// 测量</span>
  <span class="token function">performMeasure</span><span class="token punctuation">(</span>childWidthMeasureSpec<span class="token punctuation">,</span> childHeightMeasureSpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// 布局</span>
  <span class="token function">performLayout</span><span class="token punctuation">(</span>lp<span class="token punctuation">,</span> mWidth<span class="token punctuation">,</span> mHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// 绘制</span>
  <span class="token function">performDraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>MeasureSpec 表示的是一个 32 位的整数值，它的高 2 位表示测量模式 SpecMode，低 30 位表示某种测量模式下的规格大小 SpecSize。MeasureSpec 是 View 类的一个静态内部类，用来说明应该如何测量这个View。
三种测量模式。</p> <ul><li>UNSPECIFIED：不指定测量模式，父视图没有限制子视图的大小，子视图可以是想要的任何尺寸，通常用于系统内部，应用开发中很少使用到。</li> <li>EXACTLY：精确测量模式，当该视图的 宽高 指定为具体数值或者 match_parent 时生效，表示父视图已经决定了子视图的精确大小，这种模式下 View 的测量值就是 SpecSize 的值。</li> <li>AT_MOST：最大值模式，当前视图的 宽高 指定为 wrap_content 时生效，此时子视图的尺寸可以是不超过父视图运行的最大尺寸。</li></ul> <p>对 DecorView 而言，它的 MeasureSpec 由窗口尺寸和其自身的 LayoutParams 共同决定；对于普通的 View，它的 MeasureSpec 由父视图的 MeasureSpec 和其本身的 LayoutParams 共同决定</p> <br> <h3 id="measure"><a href="#measure" class="header-anchor">#</a> Measure</h3> <p>Measure用来计算 View 的实际大小。页面的测量流程从 performMeasure 方法开始。</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">performMeasure</span><span class="token punctuation">(</span><span class="token keyword">int</span> childWidthMeasureSpec<span class="token punctuation">,</span> <span class="token keyword">int</span> childHeightMeasureSpec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mView <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span>TRACE_TAG_VIEW<span class="token punctuation">,</span> <span class="token string">&quot;measure&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            mView<span class="token punctuation">.</span><span class="token function">measure</span><span class="token punctuation">(</span>childWidthMeasureSpec<span class="token punctuation">,</span> childHeightMeasureSpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span>TRACE_TAG_VIEW<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>具体操作是分发给 ViewGroup 的，由 ViewGroup 在它的 measureChild 方法中传递给子 View。ViewGroup 通过遍历自身所有的子 View，并逐个调用子 View 的 measure 方法实现测量操作。</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">measureChildren</span><span class="token punctuation">(</span><span class="token keyword">int</span> widthMeasureSpec<span class="token punctuation">,</span> <span class="token keyword">int</span> heightMeasureSpec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> size <span class="token operator">=</span> mChildrenCount<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">View</span><span class="token punctuation">[</span><span class="token punctuation">]</span> children <span class="token operator">=</span> mChildren<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">View</span> child <span class="token operator">=</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>mViewFlags <span class="token operator">&amp;</span> VISIBILITY_MASK<span class="token punctuation">)</span> <span class="token operator">!=</span> GONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">measureChild</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> widthMeasureSpec<span class="token punctuation">,</span> heightMeasureSpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>View (ViewGroup) 的 Measure 方法，最终的测量是通过回调 onMeasure 方法实现的，这个通常由 View 的特定子类自己实现，可以通过重写这个方法实现自定义 View。</p> <div class="language-java extra-class"><pre class="language-java"><code>   <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">measureChild</span><span class="token punctuation">(</span><span class="token class-name">View</span> child<span class="token punctuation">,</span> <span class="token keyword">int</span> parentWidthMeasureSpec<span class="token punctuation">,</span>
            <span class="token keyword">int</span> parentHeightMeasureSpec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">LayoutParams</span> lp <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getLayoutParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> childWidthMeasureSpec <span class="token operator">=</span> <span class="token function">getChildMeasureSpec</span><span class="token punctuation">(</span>parentWidthMeasureSpec<span class="token punctuation">,</span>
                mPaddingLeft <span class="token operator">+</span> mPaddingRight<span class="token punctuation">,</span> lp<span class="token punctuation">.</span>width<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> childHeightMeasureSpec <span class="token operator">=</span> <span class="token function">getChildMeasureSpec</span><span class="token punctuation">(</span>parentHeightMeasureSpec<span class="token punctuation">,</span>
                mPaddingTop <span class="token operator">+</span> mPaddingBottom<span class="token punctuation">,</span> lp<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>

        child<span class="token punctuation">.</span><span class="token function">measure</span><span class="token punctuation">(</span>childWidthMeasureSpec<span class="token punctuation">,</span> childHeightMeasureSpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><br> <h3 id="layout"><a href="#layout" class="header-anchor">#</a> Layout</h3> <p>Layout 过程用来确定 View 在父容器的布局位置，它是父容器获取子 View 的位置参数后，调用子 View 的 layout 方法并将位置参数传入实现的。ViewRootImpl.performLayout-&gt;host.layout-&gt;view.onLayout</p> <h3 id="draw"><a href="#draw" class="header-anchor">#</a> Draw</h3> <p>Draw 操作用来将控件绘制出来，绘制的流程从 ViewRootImpl.performDraw 方法开始。最终调用到每个 View 的 draw 方法,绘制每个具体的 View.绘制基本上可以分为六个步骤。</p></div></article> <div class="content edit-link"><br> <a href="https://github.com/your_user/your_docs_repo/edit/master/Android View的绘制流程.md" target="_blank" rel="noopener noreferrer"> </a></div> <!----></div></div></div> <center><hr width="50%"> <span id="subtitle">&quot;Someday&quot;sounds a lot like the thing people say when they actually mean &quot;Never&quot;. </span> <div class="row"><div class="offset-lg-2 col-lg-8 offset-md-1 col-md-10"><p class="small">© 2021 litton ishir. Code released under the <a href="https://opensource.org/licenses/MIT" target="_blank">MIT License</a></p></div></div></center></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5b687ac1.js" defer></script><script src="/assets/js/3.9a559813.js" defer></script><script src="/assets/js/21.672831ec.js" defer></script>
  </body>
</html>
